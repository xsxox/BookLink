<!DOCTYPE html>
<html lang="zh-CN" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <title>ä¹¦ç±è¯¦æƒ…</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
</head>
<body>
    <div id="navbar-placeholder"></div>

    <div class="container mt-4">
        <div class="row" id="book-content" style="display:none">
            <div class="col-md-4">
                <img id="b-image" class="img-fluid rounded shadow mb-3" src="">
            </div>
            <div class="col-md-8">
                <h2 id="b-title"></h2>
                <h5 class="text-muted" id="b-author"></h5>
                <p class="mt-3 lead" id="b-desc"></p>
                <hr>
                
                <!-- çŠ¶æ€ä¸æŒ‰é’®åŒº -->
                <div class="card bg-body-tertiary mb-4">
                    <div class="card-body">
                        <h5 class="card-title">å½“å‰çŠ¶æ€: <span id="b-status-text"></span></h5>
                        
                        <!-- [ä¿®æ”¹] å€Ÿé˜…ä¸­æ˜¾ç¤ºçš„è”ç³»æ–¹å¼æ¡† (å¢åŠ äº†å¤åˆ¶æŒ‰é’®) -->
                        <div id="contact-info" class="alert alert-info mt-3" style="display:none">
                            <div class="d-flex justify-content-between align-items-center">
                                <span id="contact-text-content"></span>
                                <button class="btn btn-sm btn-light border" onclick="copyText('contact-text-content', this)">ğŸ“‹ å¤åˆ¶</button>
                            </div>
                        </div>
                        
                        <div id="action-area" class="mt-3">
                            <!-- æŒ‰é’®ç”± JS ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>

                <!-- ç•™è¨€åŒº -->
                <h4>ç•™è¨€æ¿</h4>
                <ul class="list-group mb-3" id="comment-list"></ul>
                <form id="comment-form">
                    <div class="input-group">
                        <input type="text" name="text" class="form-control" placeholder="å†™ä¸‹ä½ çš„ç•™è¨€..." required>
                        <button class="btn btn-outline-primary">å‘é€</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- å€Ÿé˜…ç¡®è®¤å¼¹çª— -->
    <div class="modal fade" id="borrowConfirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ğŸ“– å€Ÿé˜…ç¡®è®¤</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>åœ¨å€Ÿé˜…ä¹‹å‰ï¼Œè¯·åŠ¡å¿…å…ˆè”ç³»ä¹¦ä¸»ç¡®è®¤æ—¶é—´å’Œåœ°ç‚¹ï¼š</p>
                    
                    <div class="alert alert-primary text-center">
                        <!-- å¤åˆ¶æŒ‰é’®åŒºåŸŸ -->
                        <div class="d-flex justify-content-center align-items-center gap-2 mb-2">
                            <h3 id="modal-owner-contact" class="mb-0 fw-bold text-break"></h3>
                            <button class="btn btn-sm btn-outline-primary bg-white" onclick="copyText('modal-owner-contact', this)" title="å¤åˆ¶">
                                copy
                            </button>
                        </div>
                        <small class="text-muted">ä¹¦ä¸»: <span id="modal-owner-name"></span></small>
                    </div>

                    <p class="text-muted small mt-3">
                        1. ç‚¹å‡»â€œå¤åˆ¶â€æŒ‰é’®è·å–è”ç³»æ–¹å¼ã€‚<br>
                        2. çº¿ä¸‹è”ç³»ä¹¦ä¸»å¹¶æ‹¿åˆ°ä¹¦åï¼Œå†ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ã€‚<br>
                        3. ç‚¹å‡»ç¡®è®¤åï¼Œä¹¦ç±çŠ¶æ€å°†å˜ä¸ºâ€œå·²å€Ÿå‡ºâ€ã€‚
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">æˆ‘å†æƒ³æƒ³</button>
                    <button type="button" class="btn btn-success" onclick="confirmBorrowAction()">å·²è”ç³»ï¼Œç¡®è®¤å€Ÿé˜…</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/app.js"></script>
    <script>
        const bookId = getQueryParam('id');
        let currentBookData = null;

        init();

        async function init() {
            if(!bookId) return alert("ä¹¦ç±IDä¸¢å¤±");
            
            const [resBook, resUser] = await Promise.all([
                fetch(`/api/books/${bookId}`),
                fetch(`/api/me`)
            ]);
            
            if(!resBook.ok) return document.body.innerHTML = "<div class='container mt-5'><h1>ä¹¦ç±ä¸å­˜åœ¨</h1></div>";

            const book = await resBook.json();
            currentBookData = book;
            
            const userData = await resUser.json();
            const currentUser = userData.user;
            const isLoggedIn = userData.loggedIn;

            // æ¸²æŸ“åŸºç¡€ä¿¡æ¯
            document.getElementById('book-content').style.display = 'flex';
            document.getElementById('b-title').innerText = book.title;
            document.getElementById('b-author').innerText = book.author || 'æœªçŸ¥ä½œè€…';
            document.getElementById('b-desc').innerText = book.description;
            document.getElementById('b-image').src = book.image || 'https://via.placeholder.com/300x400?text=No+Cover';

            // æ¸²æŸ“çŠ¶æ€
            const statusSpan = document.getElementById('b-status-text');
            const actionArea = document.getElementById('action-area');
            const contactDiv = document.getElementById('contact-info');
            const contactTextContent = document.getElementById('contact-text-content');

            const statusMap = { 'available': 'å¯å€Ÿé˜…', 'borrowed': 'å·²å€Ÿå‡º', 'returning': 'å½’è¿˜ä¸­' };
            statusSpan.innerText = statusMap[book.status];
            statusSpan.className = book.status === 'available' ? 'text-success fw-bold' : 'text-warning fw-bold';

            if (!isLoggedIn) {
                actionArea.innerHTML = `<a href="login.html" class="btn btn-primary">ç™»å½•åå€Ÿé˜…</a>`;
            } else {
                const isOwner = book.owner._id === currentUser._id;
                // å®‰å…¨è·å– borrower id
                const isBorrower = book.borrower && book.borrower._id === currentUser._id;

                if (isOwner) {
                    // --- æˆ‘æ˜¯ä¹¦ä¸» ---
                    if (book.status === 'returning') {
                        actionArea.innerHTML = `<button onclick="doAction('confirm_return')" class="btn btn-success btn-lg">ç¡®è®¤å·²æ”¶åˆ°ä¹¦</button>`;
                        contactDiv.style.display = 'block';
                        // å¡«å……è”ç³»æ–¹å¼ï¼Œä¾›å¤åˆ¶
                        contactTextContent.innerText = `${book.borrower.contact}`; 
                        // åœ¨æ–‡å­—å‰åŠ ä¸ªè¯´æ˜
                        contactTextContent.innerHTML = `<strong>å€Ÿé˜…è€…è”ç³»æ–¹å¼:</strong> <span id="copy-target-1">${book.borrower.contact}</span>`;
                        // ä¿®æ”¹æŒ‰é’®onclickæŒ‡å‘å…·ä½“çš„span id
                        contactDiv.querySelector('button').setAttribute('onclick', "copyText('copy-target-1', this)");

                    } else if (book.status === 'borrowed') {
                        contactDiv.style.display = 'block';
                        contactTextContent.innerHTML = `<strong>å€Ÿé˜…è€…è”ç³»æ–¹å¼:</strong> <span id="copy-target-2">${book.borrower.contact}</span>`;
                        contactDiv.querySelector('button').setAttribute('onclick', "copyText('copy-target-2', this)");
                        
                        actionArea.innerHTML = `<button class="btn btn-secondary" disabled>ç­‰å¾…å½’è¿˜</button>`;
                    } else {
                        actionArea.innerHTML = `
                            <button class="btn btn-secondary" disabled>è¿™æ˜¯ä½ å‘å¸ƒçš„ä¹¦</button>
                            <button onclick="deleteBook('${book._id}')" class="btn btn-outline-danger ms-2">ä¸‹æ¶/åˆ é™¤</button>
                        `;
                    }
                } else if (isBorrower) {
                    // --- æˆ‘æ˜¯å€Ÿä¹¦äºº ---
                    contactDiv.style.display = 'block';
                    contactTextContent.innerHTML = `<strong>ä¹¦ä¸»è”ç³»æ–¹å¼:</strong> <span id="copy-target-3">${book.owner.contact}</span>`;
                    contactDiv.querySelector('button').setAttribute('onclick', "copyText('copy-target-3', this)");

                    if (book.status === 'borrowed') {
                        actionArea.innerHTML = `<button onclick="doAction('return_request')" class="btn btn-warning btn-lg">ç”³è¯·è¿˜ä¹¦</button>`;
                    } else if (book.status === 'returning') {
                        actionArea.innerHTML = `<button class="btn btn-secondary" disabled>ç­‰å¾…ä¹¦ä¸»ç¡®è®¤...</button>`;
                    }
                } else {
                    // --- æˆ‘æ˜¯è·¯äºº ---
                    if (book.status === 'available') {
                        actionArea.innerHTML = `<button onclick="openBorrowModal()" class="btn btn-primary btn-lg">æˆ‘è¦å€Ÿé˜…</button>`;
                    } else {
                        actionArea.innerHTML = `<button class="btn btn-secondary" disabled>å·²è¢«ä»–äººå€Ÿèµ°</button>`;
                    }
                }
            }

            const cList = document.getElementById('comment-list');
            book.comments.forEach(c => {
                cList.innerHTML += `<li class="list-group-item"><strong>${c.user}:</strong> ${c.text}</li>`;
            });
            
            document.getElementById('comment-form').onsubmit = async (e) => {
                e.preventDefault();
                await fetch(`/api/books/${bookId}/comment`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({text: e.target.text.value})
                });
                location.reload();
            };
        }

        function openBorrowModal() {
            document.getElementById('modal-owner-contact').innerText = currentBookData.owner.contact;
            document.getElementById('modal-owner-name').innerText = currentBookData.owner.username;
            const modal = new bootstrap.Modal(document.getElementById('borrowConfirmModal'));
            modal.show();
        }

        function confirmBorrowAction() {
            doAction('borrow');
        }

        // å¤åˆ¶åŠŸèƒ½å‡½æ•°
        function copyText(elementId, btn) {
            const text = document.getElementById(elementId).innerText;
            navigator.clipboard.writeText(text).then(() => {
                const originalContent = btn.innerHTML;
                btn.innerHTML = 'âœ… å·²å¤åˆ¶';
                btn.classList.remove('btn-light', 'btn-outline-primary', 'bg-white');
                btn.classList.add('btn-success', 'text-white');

                // 2ç§’åæ¢å¤åŸçŠ¶
                setTimeout(() => {
                    btn.innerHTML = originalContent;
                    btn.classList.remove('btn-success', 'text-white');
                    btn.classList.add('btn-outline-primary', 'bg-white'); // è¿™é‡Œç®€å•æ¢å¤ä¸ºä¸€ç§æ ·å¼ï¼Œå®é™…ä¸å½±å“åŠŸèƒ½
                }, 2000);
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥', err);
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é•¿æŒ‰å¤åˆ¶');
            });
        }

        async function doAction(actionType) {
            const res = await fetch(`/api/books/${bookId}/action`, {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({action: actionType})
            });
            const data = await res.json();
            if(data.success) location.reload();
            else alert(data.message || 'æ“ä½œå¤±è´¥');
        }

        async function deleteBook(id) {
            if(!confirm("ç¡®å®šè¦ä¸‹æ¶å¹¶åˆ é™¤è¿™æœ¬ä¹¦å—ï¼Ÿ")) return;
            const res = await fetch(`/api/books/${id}`, { method: 'DELETE' });
            if ((await res.json()).success) {
                alert("åˆ é™¤æˆåŠŸ");
                window.location.href = 'profile.html';
            } else {
                alert("åˆ é™¤å¤±è´¥");
            }
        }
    </script>
</body>
</html>