<!DOCTYPE html>
<html lang="zh-CN" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <title>ä¹¦ç±è¯¦æƒ…</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div id="navbar-placeholder"></div>

    <div class="container mt-4">
        <div class="row" id="book-content" style="display:none">
            <div class="col-md-4">
                <!-- å›¾ç‰‡å±•ç¤º -->
                <img id="b-image" class="img-fluid rounded shadow mb-3" src="">
            </div>
            <div class="col-md-8">
                <h2 id="b-title"></h2>
                <h5 class="text-muted" id="b-author"></h5>
                <p class="mt-3 lead" id="b-desc"></p>
                <hr>
                
                <!-- çŠ¶æ€ä¸æŒ‰é’®åŒº -->
                <div class="card bg-body-tertiary mb-4">
                    <div class="card-body">
                        <h5 class="card-title">å½“å‰çŠ¶æ€: <span id="b-status-text"></span></h5>
                        
                        <!-- è¿™é‡Œçš„è”ç³»æ–¹å¼æ¡†ï¼Œåªæœ‰åœ¨å€Ÿé˜…ä¸­æ‰ä¼šæ˜¾ç¤ºåœ¨é¡µé¢ä¸Š -->
                        <div id="contact-info" class="alert alert-info mt-3" style="display:none"></div>
                        
                        <div id="action-area" class="mt-3">
                            <!-- æŒ‰é’®ç”± JS åŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>

                <!-- ç•™è¨€åŒº -->
                <h4>ç•™è¨€æ¿</h4>
                <ul class="list-group mb-3" id="comment-list"></ul>
                <form id="comment-form">
                    <div class="input-group">
                        <input type="text" name="text" class="form-control" placeholder="å†™ä¸‹ä½ çš„ç•™è¨€..." required>
                        <button class="btn btn-outline-primary">å‘é€</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- [æ–°å¢] å€Ÿé˜…å‰ç¡®è®¤å¼¹çª— (Modal) -->
    <div class="modal fade" id="borrowConfirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ğŸ“– å€Ÿé˜…ç¡®è®¤</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>åœ¨å€Ÿé˜…ä¹‹å‰ï¼Œè¯·åŠ¡å¿…å…ˆè”ç³»ä¹¦ä¸»ç¡®è®¤æ—¶é—´å’Œåœ°ç‚¹ï¼š</p>
                    <div class="alert alert-primary text-center">
                        <h4 id="modal-owner-contact" class="mb-0 fw-bold"></h4>
                        <small class="text-muted">ä¹¦ä¸»: <span id="modal-owner-name"></span></small>
                    </div>
                    <p class="text-muted small">
                        1. è¯·è®°ä¸‹è”ç³»æ–¹å¼ã€‚<br>
                        2. çº¿ä¸‹è”ç³»ä¹¦ä¸»å¹¶æ‹¿åˆ°ä¹¦åï¼Œå†ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ã€‚<br>
                        3. ç‚¹å‡»ç¡®è®¤åï¼Œä¹¦ç±çŠ¶æ€å°†å˜ä¸ºâ€œå·²å€Ÿå‡ºâ€ã€‚
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">æˆ‘å†æƒ³æƒ³</button>
                    <!-- ç‚¹å‡»è¿™ä¸ªæŒ‰é’®æ‰ä¼šçœŸæ­£å‘é€è¯·æ±‚ -->
                    <button type="button" class="btn btn-success" onclick="confirmBorrowAction()">å·²è”ç³»ï¼Œç¡®è®¤å€Ÿé˜…</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/app.js"></script>
    <script>
        const bookId = getQueryParam('id');
        let currentBookData = null; // ç”¨äºå­˜å‚¨å½“å‰ä¹¦ç±æ•°æ®ä¾›å¼¹çª—ä½¿ç”¨

        init();

        async function init() {
            if(!bookId) return alert("ä¹¦ç±IDä¸¢å¤±");
            
            // 1. è·å–æ•°æ®
            const [resBook, resUser] = await Promise.all([
                fetch(`/api/books/${bookId}`),
                fetch(`/api/me`)
            ]);
            
            if(!resBook.ok) return document.body.innerHTML = "<div class='container mt-5'><h1>ä¹¦ç±ä¸å­˜åœ¨</h1></div>";

            const book = await resBook.json();
            currentBookData = book; // ä¿å­˜æ•°æ®åˆ°å…¨å±€å˜é‡
            
            const userData = await resUser.json();
            const currentUser = userData.user;
            const isLoggedIn = userData.loggedIn;

            // 2. æ¸²æŸ“åŸºç¡€ä¿¡æ¯
            document.getElementById('book-content').style.display = 'flex';
            document.getElementById('b-title').innerText = book.title;
            document.getElementById('b-author').innerText = book.author || 'æœªçŸ¥ä½œè€…';
            document.getElementById('b-desc').innerText = book.description;
            document.getElementById('b-image').src = book.image || 'https://via.placeholder.com/300x400?text=No+Cover';

            // 3. æ¸²æŸ“çŠ¶æ€
            const statusSpan = document.getElementById('b-status-text');
            const actionArea = document.getElementById('action-area');
            const contactDiv = document.getElementById('contact-info');

            const statusMap = { 'available': 'å¯å€Ÿé˜…', 'borrowed': 'å·²å€Ÿå‡º', 'returning': 'å½’è¿˜ä¸­' };
            statusSpan.innerText = statusMap[book.status];
            statusSpan.className = book.status === 'available' ? 'text-success fw-bold' : 'text-warning fw-bold';

            // 4. æŒ‰é’®é€»è¾‘ (æ ¸å¿ƒä¿®æ”¹éƒ¨åˆ†)
            if (!isLoggedIn) {
                actionArea.innerHTML = `<a href="login.html" class="btn btn-primary">ç™»å½•åå€Ÿé˜…</a>`;
            } else {
                const isOwner = book.owner._id === currentUser._id;
                const isBorrower = book.borrower && book.borrower._id === currentUser._id;

                if (isOwner) {
                    // --- æˆ‘æ˜¯ä¹¦ä¸» ---
                    if (book.status === 'returning') {
                        actionArea.innerHTML = `<button onclick="doAction('confirm_return')" class="btn btn-success btn-lg">ç¡®è®¤å·²æ”¶åˆ°ä¹¦</button>`;
                        contactDiv.style.display = 'block';
                        contactDiv.innerText = `å€Ÿé˜…è€… ${book.borrower.username} å·²å½’è¿˜ï¼Œè¯·ç¡®è®¤ã€‚TAçš„è”ç³»æ–¹å¼: ${book.borrower.contact}`;
                    } else if (book.status === 'borrowed') {
                        contactDiv.style.display = 'block';
                        contactDiv.innerText = `å½“å‰å€Ÿé˜…è€…: ${book.borrower.username}ï¼Œè”ç³»æ–¹å¼: ${book.borrower.contact}`;
                        actionArea.innerHTML = `<button class="btn btn-secondary" disabled>ç­‰å¾…å½’è¿˜</button>`;
                    } else {
                        actionArea.innerHTML = `
                            <button class="btn btn-secondary" disabled>è¿™æ˜¯ä½ å‘å¸ƒçš„ä¹¦</button>
                            <button onclick="deleteBook('${book._id}')" class="btn btn-outline-danger ms-2">ä¸‹æ¶/åˆ é™¤</button>
                        `;
                    }
                } else if (isBorrower) {
                    // --- æˆ‘æ˜¯å€Ÿä¹¦äºº ---
                    // å€Ÿé˜…ä¸­ï¼Œå§‹ç»ˆæ˜¾ç¤ºè”ç³»æ–¹å¼ (é˜²æ­¢é—å¿˜)
                    contactDiv.style.display = 'block';
                    contactDiv.innerText = `ä¹¦ä¸»è”ç³»æ–¹å¼: ${book.owner.contact} (ä¹¦ä¸»: ${book.owner.username})`;

                    if (book.status === 'borrowed') {
                        actionArea.innerHTML = `<button onclick="doAction('return_request')" class="btn btn-warning btn-lg">ç”³è¯·è¿˜ä¹¦</button>`;
                    } else if (book.status === 'returning') {
                        actionArea.innerHTML = `<button class="btn btn-secondary" disabled>ç­‰å¾…ä¹¦ä¸»ç¡®è®¤...</button>`;
                    }
                } else {
                    // --- æˆ‘æ˜¯è·¯äºº ---
                    if (book.status === 'available') {
                        // [ä¿®æ”¹ç‚¹] è¿™é‡Œä¸å†ç›´æ¥å€Ÿé˜…ï¼Œè€Œæ˜¯æ‰“å¼€å¼¹çª—
                        actionArea.innerHTML = `<button onclick="openBorrowModal()" class="btn btn-primary btn-lg">æˆ‘è¦å€Ÿé˜…</button>`;
                    } else {
                        actionArea.innerHTML = `<button class="btn btn-secondary" disabled>å·²è¢«ä»–äººå€Ÿèµ°</button>`;
                    }
                }
            }

            // æ¸²æŸ“ç•™è¨€
            const cList = document.getElementById('comment-list');
            book.comments.forEach(c => {
                cList.innerHTML += `<li class="list-group-item"><strong>${c.user}:</strong> ${c.text}</li>`;
            });
            
            // ç»‘å®šç•™è¨€æäº¤
            document.getElementById('comment-form').onsubmit = async (e) => {
                e.preventDefault();
                await fetch(`/api/books/${bookId}/comment`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({text: e.target.text.value})
                });
                location.reload();
            };
        }

        // [æ–°å¢] æ‰“å¼€å€Ÿé˜…ç¡®è®¤å¼¹çª—
        function openBorrowModal() {
            // å¡«å……å¼¹çª—é‡Œçš„æ•°æ®
            document.getElementById('modal-owner-contact').innerText = currentBookData.owner.contact;
            document.getElementById('modal-owner-name').innerText = currentBookData.owner.username;
            
            // ä½¿ç”¨ Bootstrap API æ˜¾ç¤ºå¼¹çª—
            const modal = new bootstrap.Modal(document.getElementById('borrowConfirmModal'));
            modal.show();
        }

        // [æ–°å¢] å¼¹çª—é‡Œçš„ç¡®è®¤æŒ‰é’®ç‚¹å‡»åï¼Œæ‰æ‰§è¡ŒçœŸæ­£çš„å€Ÿé˜…
        function confirmBorrowAction() {
            doAction('borrow');
        }

        // é€šç”¨æ“ä½œå‡½æ•°
        async function doAction(actionType) {
            const res = await fetch(`/api/books/${bookId}/action`, {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({action: actionType})
            });
            const data = await res.json();
            if(data.success) location.reload();
            else alert(data.message || 'æ“ä½œå¤±è´¥');
        }

        // åˆ é™¤å‡½æ•°
        async function deleteBook(id) {
            if(!confirm("ç¡®å®šè¦ä¸‹æ¶å¹¶åˆ é™¤è¿™æœ¬ä¹¦å—ï¼Ÿ")) return;
            const res = await fetch(`/api/books/${id}`, { method: 'DELETE' });
            if ((await res.json()).success) {
                alert("åˆ é™¤æˆåŠŸ");
                window.location.href = 'profile.html';
            } else {
                alert("åˆ é™¤å¤±è´¥");
            }
        }
    </script>
</body>
</html>